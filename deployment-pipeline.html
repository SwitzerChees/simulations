<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deployment Pipeline Simulation</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    keyframes: {
                        scan: {
                            '0%': { transform: 'translateY(-20px)' },
                            '100%': { transform: 'translateY(80px)' }
                        },
                        pulse: {
                            '0%': { transform: 'scale(1)', opacity: '1' },
                            '50%': { transform: 'scale(1.05)', opacity: '0.5' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        }
                    },
                    animation: {
                        scan: 'scan 1.5s ease-in-out infinite',
                        pulse: 'pulse 1.5s infinite'
                    }
                }
            }
        }
    </script>
    <style>
        body {
            @apply m-0 overflow-hidden font-sans;
        }

        .scanning::after {
            content: '';
            @apply absolute top-0 left-0 w-full h-5 bg-gradient-to-b from-transparent via-white/70 to-transparent animate-scan pointer-events-none;
        }

        .gate-status-dot::before {
            content: '';
            @apply absolute w-3 h-3 rounded-full bg-gray-400 transition-colors duration-300;
        }

        .gate-status-dot.success::before {
            @apply bg-green-500;
        }

        .gate-status-dot.error::before {
            @apply bg-red-500;
        }

        .active-pod::before {
            content: '';
            @apply absolute -inset-1 border-2 border-green-500 rounded-lg transition-all duration-300 animate-pulse;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="relative w-full h-screen">
        <!-- Stages -->
        <div id="dev-stage" class="absolute rounded-lg p-4 text-center shadow-md transition-all duration-300 bg-blue-100 text-blue-800" style="width: 200px; height: 150px; left: 100px; top: 50px;">
            <h3 class="text-lg font-bold mb-2">Development</h3>
            <p class="text-sm">Code is written and unit tested</p>
            <div class="status-indicator absolute w-4 h-4 rounded-full right-3 top-3 bg-gray-300"></div>
        </div>
        
        <!-- Test Environment with Kubernetes -->
        <div id="test-stage" class="absolute rounded-lg p-4 text-center shadow-md transition-all duration-300 bg-yellow-100 text-yellow-800" style="width: 400px; height: 300px; left: 400px; top: 50px;">
            <h3 class="text-lg font-bold mb-2">Testing Environment</h3>
            <p class="text-sm mb-4">Kubernetes Test Cluster</p>
            
            <!-- Kubernetes Test Cluster -->
            <div class="bg-yellow-50 p-4 rounded-lg border-2 border-yellow-300 transition-all duration-300">
                <div class="bg-white p-2 rounded mb-2 shadow transition-all duration-300">
                    <h4 class="text-sm font-bold">Node 1</h4>
                    <div class="flex gap-2 mt-2">
                        <div class="bg-blue-200 p-2 rounded text-xs transition-all duration-300 hover:scale-105">
                            Node.js Pod
                        </div>
                        <div class="bg-orange-200 p-2 rounded text-xs transition-all duration-300 hover:scale-105">
                            DB Pod
                        </div>
                    </div>
                </div>
            </div>
            <div class="status-indicator absolute w-4 h-4 rounded-full right-3 top-3 bg-gray-300"></div>
        </div>
        
        <!-- Production Environment with Kubernetes -->
        <div id="prod-stage" class="absolute rounded-lg p-4 text-center shadow-md transition-all duration-300 bg-green-100 text-green-800" style="width: 400px; height: 300px; left: 900px; top: 50px;">
            <h3 class="text-lg font-bold mb-2">Production Environment</h3>
            <p class="text-sm mb-4">Kubernetes Production Cluster</p>
            
            <!-- Kubernetes Production Cluster -->
            <div class="bg-green-50 p-4 rounded-lg border-2 border-green-300 transition-all duration-300">
                <div class="bg-white p-2 rounded mb-2 shadow transition-all duration-300">
                    <h4 class="text-sm font-bold">Node 1</h4>
                    <div class="flex gap-2 mt-2">
                        <div class="bg-blue-200 p-2 rounded text-xs transition-all duration-300 hover:scale-105">
                            Node.js Pod
                        </div>
                        <div class="bg-orange-200 p-2 rounded text-xs transition-all duration-300 hover:scale-105">
                            DB Pod
                        </div>
                    </div>
                </div>
                <div class="bg-white p-2 rounded mb-2 shadow transition-all duration-300">
                    <h4 class="text-sm font-bold">Node 2</h4>
                    <div class="flex gap-2 mt-2">
                        <div class="bg-blue-200 p-2 rounded text-xs transition-all duration-300 hover:scale-105">
                            Node.js Pod
                        </div>
                        <div class="bg-orange-200 p-2 rounded text-xs transition-all duration-300 hover:scale-105">
                            DB Pod
                        </div>
                    </div>
                </div>
            </div>
            <div class="status-indicator absolute w-4 h-4 rounded-full right-3 top-3 bg-gray-300"></div>
        </div>
        
        <!-- Pipelines -->
        <div class="absolute h-2.5 bg-gray-200 z-0" style="width: 100px; left: 300px; top: 125px;"></div>
        <div class="absolute h-2.5 bg-gray-200 z-0" style="width: 100px; left: 800px; top: 125px;"></div>
        
        <!-- Quality Gates -->
        <div id="gate1" class="absolute w-12 h-12 flex justify-center items-center text-white font-bold shadow-md z-10 bg-gray-600 overflow-hidden" style="left: 325px; top: 100px;">
            QG1
        </div>
        
        <div id="gate2" class="absolute w-12 h-12 flex justify-center items-center text-white font-bold shadow-md z-10 bg-gray-600 overflow-hidden" style="left: 825px; top: 100px;">
            QG2
        </div>
        
        <!-- Container Registry -->
        <div class="absolute bg-purple-100 text-purple-800 p-4 rounded-lg border-2 border-purple-300 transition-all duration-300" 
             style="width: 150px; left: 525px; top: 400px;">
            <h4 class="text-sm font-bold mb-2">Container Registry</h4>
            <div class="space-y-1 text-xs">
                <div class="bg-white p-2 rounded transition-all duration-200 hover:translate-x-1 hover:bg-gray-50">nodejs-app:latest</div>
                <div class="bg-white p-2 rounded transition-all duration-200 hover:translate-x-1 hover:bg-gray-50">database:latest</div>
            </div>
        </div>
        
        <!-- Gate Popups -->
        <div id="gate1-popup" class="absolute bg-white border border-gray-200 rounded-lg p-4 shadow-lg z-20 hidden" style="left: 350px; top: 150px;">
            <h4 class="font-bold text-gray-800 mb-2">Quality Gate 1</h4>
            <ul class="list-disc pl-5 text-sm text-gray-600 space-y-1">
                <li>Code review</li>
                <li>Unit tests pass (>80%)</li>
                <li>Static code analysis</li>
                <li>Build succeeds</li>
            </ul>
        </div>
        
        <div id="gate2-popup" class="absolute bg-white border border-gray-200 rounded-lg p-4 shadow-lg z-20 hidden" style="left: 825px; top: 150px;">
            <h4 class="font-bold text-gray-800 mb-2">Quality Gate 2</h4>
            <ul class="list-disc pl-5 text-sm text-gray-600 space-y-1">
                <li>Integration tests pass</li>
                <li>Performance tests</li>
                <li>Security scan</li>
                <li>UAT approval</li>
            </ul>
        </div>
        
        <!-- Controls -->
        <div class="absolute bottom-5 left-1/2 transform -translate-x-1/2 z-10 flex gap-3">
            <button id="startBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors duration-200">
                Start Deployment
            </button>
            <button id="resetBtn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded transition-colors duration-200">
                Reset
            </button>
        </div>
        
        <!-- Legend -->
        <div class="absolute top-5 right-5 bg-white/90 rounded-lg p-4 shadow-md">
            <h4 class="font-bold mb-2">Legend</h4>
            <div class="flex items-center mb-2">
                <div class="w-4 h-4 mr-3 rounded bg-blue-500"></div>
                <span>Code Package</span>
            </div>
            <div class="flex items-center mb-2">
                <div class="w-4 h-4 mr-3 rounded bg-green-400"></div>
                <span>Success</span>
            </div>
            <div class="flex items-center mb-2">
                <div class="w-4 h-4 mr-3 rounded bg-red-500"></div>
                <span>Failure</span>
            </div>
            <div class="flex items-center mb-2">
                <div class="w-4 h-4 mr-3 rounded bg-yellow-400"></div>
                <span>In Progress</span>
            </div>
            <div class="flex items-center mb-2">
                <div class="w-4 h-4 mr-3 rounded bg-gray-400"></div>
                <span>Idle</span>
            </div>
            <div class="flex items-center mb-2">
                <div class="w-4 h-4 mr-3 rounded bg-gray-600"></div>
                <span>Quality Gate</span>
            </div>
        </div>
    </div>
    
    <script>
        // Main variables
        let deploymentStage = 0;
        let codePackage = null;
        let isRunning = false;
        let failureRate = 0.2; // 20% chance of failure at each gate
        
        // DOM elements
        const startBtn = document.getElementById('startBtn');
        const resetBtn = document.getElementById('resetBtn');
        const devStage = document.getElementById('dev-stage');
        const testStage = document.getElementById('test-stage');
        const prodStage = document.getElementById('prod-stage');
        const gate1 = document.getElementById('gate1');
        const gate2 = document.getElementById('gate2');
        const gate1Popup = document.getElementById('gate1-popup');
        const gate2Popup = document.getElementById('gate2-popup');
        
        // Event listeners
        startBtn.addEventListener('click', startDeployment);
        resetBtn.addEventListener('click', resetDeployment);
        
        // Gate popup listeners
        gate1.addEventListener('mouseenter', () => gate1Popup.classList.remove('hidden'));
        gate1.addEventListener('mouseleave', () => gate1Popup.classList.add('hidden'));
        gate2.addEventListener('mouseenter', () => gate2Popup.classList.remove('hidden'));
        gate2.addEventListener('mouseleave', () => gate2Popup.classList.add('hidden'));
        
        // Initialize the state
        function init() {
            updateStageStatus(devStage, 'idle');
            updateStageStatus(testStage, 'idle');
            updateStageStatus(prodStage, 'idle');
        }
        
        // Start the deployment process
        function startDeployment() {
            if (isRunning) return;
            
            isRunning = true;
            deploymentStage = 0;
            resetDeployment(false);
            
            // Create code package
            codePackage = document.createElement('div');
            codePackage.className = 'absolute w-8 h-8 bg-blue-600 rounded transition-all duration-500 shadow-md z-10';
            codePackage.style.left = (devStage.offsetLeft + devStage.offsetWidth / 2 - 15) + 'px';
            codePackage.style.top = (devStage.offsetTop + devStage.offsetHeight / 2 - 15) + 'px';
            document.querySelector('.relative').appendChild(codePackage);
            
            // Start the deployment flow
            updateStageStatus(devStage, 'processing');
            simulateDevelopment();
        }

        // Create container image
        function createContainerImage() {
            const image = document.createElement('div');
            image.className = 'absolute w-8 h-8 bg-indigo-400 rounded transition-all duration-500 shadow-md z-10';
            return image;
        }

        // Deploy containers to Kubernetes
        function deployToKubernetes(stage, onComplete) {
            const container = createContainerImage();
            document.querySelector('.relative').appendChild(container);

            // Move to registry first
            const registry = document.querySelector('.bg-purple-100');
            container.style.left = (registry.offsetLeft + registry.offsetWidth / 2 - 15) + 'px';
            container.style.top = (registry.offsetTop + 20) + 'px';

            setTimeout(() => {
                // Find target node in the stage
                const targetStage = stage === 'test' ? testStage : prodStage;
                const node = targetStage.querySelector('.bg-yellow-50, .bg-green-50');
                const pods = node.querySelectorAll('.bg-blue-200, .bg-orange-200');

                // Animate containers to pods
                pods.forEach((pod, index) => {
                    const newContainer = createContainerImage();
                    document.querySelector('.relative').appendChild(newContainer);
                    newContainer.style.left = container.style.left;
                    newContainer.style.top = container.style.top;

                    setTimeout(() => {
                        const rect = pod.getBoundingClientRect();
                        newContainer.style.left = (rect.left + window.scrollX) + 'px';
                        newContainer.style.top = (rect.top + window.scrollY) + 'px';
                        newContainer.style.transform = 'scale(0.5)';

                        setTimeout(() => {
                            pod.classList.remove('bg-white');
                            pod.classList.add(index === 0 ? 'bg-blue-200' : 'bg-orange-200', 'scale-110');
                            setTimeout(() => {
                                pod.classList.remove('scale-110');
                                newContainer.remove();
                            }, 300);
                        }, 500);
                    }, index * 500);
                });

                // Remove original container
                setTimeout(() => {
                    container.remove();
                    if (onComplete) onComplete();
                }, pods.length * 500 + 1000);
            }, 1000);
        }
        
        // Reset the deployment
        function resetDeployment(resetRunningState = true) {
            if (codePackage && codePackage.parentNode) {
                codePackage.parentNode.removeChild(codePackage);
            }
            
            codePackage = null;
            if (resetRunningState) {
                isRunning = false;
            }
            
            updateStageStatus(devStage, 'idle');
            updateStageStatus(testStage, 'idle');
            updateStageStatus(prodStage, 'idle');
        }
        
        // Update the visual status of a stage
        function updateStageStatus(element, status) {
            const indicator = element.querySelector('.status-indicator');
            
            // Remove all possible status classes
            indicator.classList.remove('bg-gray-300', 'bg-yellow-400', 'bg-green-400', 'bg-red-500', 'animate-pulse');
            element.classList.remove('border-2', 'border-yellow-400', 'border-green-400', 'border-red-500', 'shadow-lg');
            
            switch(status) {
                case 'idle':
                    indicator.classList.add('bg-gray-300');
                    break;
                case 'processing':
                    indicator.classList.add('bg-yellow-400', 'animate-pulse');
                    element.classList.add('border-2', 'border-yellow-400', 'shadow-lg');
                    break;
                case 'success':
                    indicator.classList.add('bg-green-400');
                    element.classList.add('border-2', 'border-green-400', 'shadow-lg');
                    break;
                case 'failure':
                    indicator.classList.add('bg-red-500');
                    element.classList.add('border-2', 'border-red-500', 'shadow-lg');
                    break;
            }
        }
        
        // Move code package to a target
        function movePackageTo(target, onComplete) {
            const targetX = target.offsetLeft + target.offsetWidth / 2 - 15;
            const targetY = target.offsetTop + target.offsetHeight / 2 - 15;
            
            codePackage.style.left = targetX + 'px';
            codePackage.style.top = targetY + 'px';
            
            // Wait for transition to complete
            setTimeout(onComplete, 600);
        }
        
        // Development stage simulation
        function simulateDevelopment() {
            setTimeout(() => {
                updateStageStatus(devStage, 'success');
                deploymentStage = 1;
                
                // Move to first gate
                movePackageTo(gate1, checkGate1);
            }, 2000);
        }
        
        // Show a step label for a short duration
        function showStepLabel(gate, text, top) {
            const existingLabel = gate.querySelector('[data-step-label]');
            if (existingLabel) {
                existingLabel.remove();
            }

            const label = document.createElement('div');
            label.className = 'absolute left-1/2 transform -translate-x-1/2 bg-white px-3 py-2 rounded text-sm shadow-md z-10 border border-gray-200 text-gray-700 whitespace-nowrap opacity-0 transition-all duration-300';
            label.setAttribute('data-step-label', '');
            label.textContent = text;
            
            // Calculate position below the stage boxes
            const nearestStage = gate.id === 'gate1' ? 
                document.getElementById('test-stage') : 
                document.getElementById('prod-stage');
            
            const stageBottom = nearestStage.offsetTop + nearestStage.offsetHeight;
            label.style.top = (stageBottom + 20 + top) + 'px';
            document.querySelector('.relative').appendChild(label);
            label.style.left = (gate.offsetLeft + gate.offsetWidth/2) + 'px';
            
            // Add success/failure styling
            if (text.includes('passed')) {
                label.classList.add('bg-green-50', 'border-green-300', 'text-green-800');
            } else if (text.includes('failed')) {
                label.classList.add('bg-red-50', 'border-red-300', 'text-red-800');
            }

            setTimeout(() => {
                label.classList.remove('opacity-0');
                label.classList.add('opacity-100');
                setTimeout(() => {
                    label.classList.remove('opacity-100');
                    label.classList.add('opacity-0');
                    setTimeout(() => {
                        if (label.parentNode) {
                            label.parentNode.removeChild(label);
                        }
                    }, 300);
                }, 1500);
            }, 100);
        }

        // Check first quality gate
        function checkGate1() {
            gate1.classList.add('scanning');
            gate1.classList.add('bg-yellow-500');
            
            // Show step labels for each check
            const steps = [
                { text: 'Running unit tests...', delay: 0 },
                { text: 'Checking code coverage...', delay: 500 },
                { text: 'Analyzing code quality...', delay: 1000 },
                { text: 'Validating dependencies...', delay: 1500 }
            ];

            steps.forEach((step, index) => {
                setTimeout(() => {
                    showStepLabel(gate1, step.text, index * 25);
                }, step.delay);
            });
            
            setTimeout(() => {
                const passed = Math.random() > failureRate;
                
                if (passed) {
                    gate1.classList.remove('bg-yellow-500');
                    gate1.classList.add('bg-green-500');
                    gate1.classList.remove('scanning');
                    showStepLabel(gate1, 'All checks passed!', 10);
                    
                    setTimeout(() => {
                        // Move to test stage
                        movePackageTo(testStage, enterTestStage);
                    }, 1000);
                } else {
                    gate1.classList.remove('bg-yellow-500');
                    gate1.classList.add('bg-red-500');
                    gate1.classList.remove('scanning');
                    showStepLabel(gate1, 'Check failed!', 10);
                    
                    // Simulate failure
                    setTimeout(() => {
                        if (codePackage) {
                            codePackage.style.opacity = '0';
                            setTimeout(() => {
                                if (codePackage && codePackage.parentNode) {
                                    codePackage.parentNode.removeChild(codePackage);
                                }
                                codePackage = null;
                                isRunning = false;
                                gate1.classList.remove('bg-red-500');
                                gate1.classList.add('bg-gray-500');
                            }, 500);
                        }
                    }, 1000);
                }
            }, 2000);
        }
        
        // Enter test stage
        function enterTestStage() {
            updateStageStatus(testStage, 'processing');
            gate1.classList.remove('bg-green-500');
            gate1.classList.add('bg-gray-500');
            
            // Deploy to test environment
            deployToKubernetes('test', () => {
                setTimeout(() => {
                    updateStageStatus(testStage, 'success');
                    deploymentStage = 2;
                    
                    // Move to second gate
                    movePackageTo(gate2, checkGate2);
                }, 2000);
            });
        }
        
        // Check second quality gate
        function checkGate2() {
            gate2.classList.add('scanning');
            gate2.classList.add('bg-yellow-500');
            
            // Show step labels for each check
            const steps = [
                { text: 'Checking integration tests...', delay: 0 },
                { text: 'Validating API endpoints...', delay: 500 },
                { text: 'Testing database migrations...', delay: 1000 },
                { text: 'Verifying performance...', delay: 1500 }
            ];

            steps.forEach((step, index) => {
                setTimeout(() => {
                    showStepLabel(gate2, step.text, index * 25);
                }, step.delay);
            });
            
            setTimeout(() => {
                const passed = Math.random() > failureRate;
                
                if (passed) {
                    gate2.classList.remove('bg-yellow-500');
                    gate2.classList.add('bg-green-500');
                    gate2.classList.remove('scanning');
                    showStepLabel(gate2, 'All checks passed!', 10);
                    
                    setTimeout(() => {
                        // Move to production stage
                        movePackageTo(prodStage, enterProdStage);
                    }, 1000);
                } else {
                    gate2.classList.remove('bg-yellow-500');
                    gate2.classList.add('bg-red-500');
                    gate2.classList.remove('scanning');
                    showStepLabel(gate2, 'Check failed!', 10);
                    
                    // Simulate failure
                    setTimeout(() => {
                        if (codePackage) {
                            codePackage.style.opacity = '0';
                            setTimeout(() => {
                                if (codePackage && codePackage.parentNode) {
                                    codePackage.parentNode.removeChild(codePackage);
                                }
                                codePackage = null;
                                isRunning = false;
                                gate2.classList.remove('bg-red-500');
                                gate2.classList.add('bg-gray-500');
                            }, 500);
                        }
                    }, 1000);
                }
            }, 2000);
        }
        
        // Enter production stage
        function enterProdStage() {
            updateStageStatus(prodStage, 'processing');
            gate2.classList.remove('bg-green-500');
            gate2.classList.add('bg-gray-500');
            
            // Deploy to production environment
            deployToKubernetes('prod', () => {
                setTimeout(() => {
                    updateStageStatus(prodStage, 'success');
                    deploymentStage = 3;
                    
                    // Enable restarting
                    isRunning = false;
                }, 2000);
            });
        }
        
        // Initialize on page load
        window.onload = init;
    </script>
</body>
</html>
