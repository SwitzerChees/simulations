<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deployment Pipeline Simulation</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    keyframes: {
                        scan: {
                            '0%': { transform: 'translateY(-20px)' },
                            '100%': { transform: 'translateY(80px)' }
                        },
                        pulse: {
                            '0%': { transform: 'scale(1)', opacity: '1' },
                            '50%': { transform: 'scale(1.05)', opacity: '0.5' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        }
                    },
                    animation: {
                        scan: 'scan 1.5s ease-in-out infinite',
                        pulse: 'pulse 1.5s infinite'
                    }
                }
            }
        }
    </script>
    <style>
        body {
            @apply m-0 overflow-hidden font-sans;
        }

        .scanning::after {
            content: '';
            @apply absolute top-0 left-0 w-full h-5 bg-gradient-to-b from-transparent via-white/70 to-transparent animate-scan pointer-events-none;
        }

        .gate-status-dot::before {
            content: '';
            @apply absolute w-3 h-3 rounded-full bg-gray-400 transition-colors duration-300;
        }

        .gate-status-dot.success::before {
            @apply bg-green-500;
        }

        .gate-status-dot.error::before {
            @apply bg-red-500;
        }

        .active-pod::before {
            content: '';
            @apply absolute -inset-1 border-2 border-green-500 rounded-lg transition-all duration-300 animate-pulse;
        }
        
        /* Connection Path Animations */
        .connection-path {
            stroke-dasharray: 12;
            animation: dash 1.5s linear infinite;
        }
        
        @keyframes dash {
            to {
                stroke-dashoffset: -24;
            }
        }
        
        /* CI/CD Indicators */
        .ci-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: #3b82f6;
            color: white;
            font-size: 0.7rem;
            font-weight: bold;
            padding: 3px 6px;
            border-radius: 9px;
            z-index: 20;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .cd-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: #10b981;
            color: white;
            font-size: 0.7rem;
            font-weight: bold;
            padding: 3px 6px;
            border-radius: 9px;
            z-index: 20;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .ci-border {
            border: 2px solid #3b82f6 !important;
        }
        
        .cd-border {
            border: 2px solid #10b981 !important;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="relative w-full h-screen">
        <!-- Stages -->
        <div id="dev-stage" class="absolute rounded-lg p-4 text-center shadow-md transition-all duration-300 bg-blue-100 text-blue-800 ci-border" style="width: 200px; height: 150px; left: 100px; top: 30px;">
            <div class="ci-badge">CI</div>
            <h3 class="text-lg font-bold mb-2">Development</h3>
            <p class="text-sm">Code is written and unit tested</p>
            <div class="status-indicator absolute w-4 h-4 rounded-full right-3 top-3 bg-gray-300"></div>
        </div>
        
        <!-- Test Environment with Kubernetes -->
        <div id="test-stage" class="absolute rounded-lg p-4 text-center shadow-md transition-all duration-300 bg-yellow-100 text-yellow-800 cd-border" style="width: 400px; height: 300px; left: 400px; top: 30px;">
            <div class="cd-badge">CD</div>
            <h3 class="text-lg font-bold mb-2">Testing Environment</h3>
            <p class="text-sm mb-1">Kubernetes Test Cluster</p>
            <p class="text-xs mb-4 text-yellow-600 version-label">No version deployed</p>
            
            <!-- Kubernetes Test Cluster -->
            <div class="bg-yellow-50 p-4 rounded-lg border-2 border-yellow-300 transition-all duration-300">
                <div class="bg-white p-2 rounded mb-2 shadow transition-all duration-300">
                    <h4 class="text-sm font-bold">Node 1</h4>
                    <div class="flex gap-2 mt-2">
                        <div class="bg-white p-2 rounded text-xs transition-all duration-300 hover:scale-105 opacity-0">
                            <div>Node.js Pod</div>
                            <div class="text-[10px] mt-1 text-gray-500 pod-version"></div>
                            <div class="flex gap-1 mt-1">
                                <div class="w-2 h-2 rounded-full bg-green-500"></div>
                            </div>
                        </div>
                        <div class="bg-white p-2 rounded text-xs transition-all duration-300 hover:scale-105 opacity-0">
                            <div>DB Pod</div>
                            <div class="text-[10px] mt-1 text-gray-500 pod-version"></div>
                            <div class="flex gap-1 mt-1">
                                <div class="w-2 h-2 rounded-full bg-green-500"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="status-indicator absolute w-4 h-4 rounded-full right-3 top-3 bg-gray-300"></div>
        </div>
        
        <!-- Production Environment with Kubernetes -->
        <div id="prod-stage" class="absolute rounded-lg p-4 text-center shadow-md transition-all duration-300 bg-green-100 text-green-800 cd-border" style="width: 400px; height: 520px; left: 900px; top: 30px;">
            <div class="cd-badge">CD</div>
            <h3 class="text-lg font-bold mb-2">Production Environment</h3>
            <p class="text-sm mb-1">Kubernetes Production Cluster</p>
            <p class="text-xs mb-4 text-green-600 version-label">No version deployed</p>
            
            <!-- Kubernetes Production Cluster -->
            <div class="bg-green-50 p-4 rounded-lg border-2 border-green-300 transition-all duration-300">
                <div class="bg-white p-2 rounded mb-2 shadow transition-all duration-300">
                    <h4 class="text-sm font-bold">Node 1</h4>
                    <div class="flex gap-2 mt-2">
                        <div class="bg-white p-2 rounded text-xs transition-all duration-300 hover:scale-105 opacity-0">
                            <div>Node.js Pod</div>
                            <div class="text-[10px] mt-1 text-gray-500 pod-version"></div>
                            <div class="flex gap-1 mt-1">
                                <div class="w-2 h-2 rounded-full bg-green-500"></div>
                            </div>
                        </div>
                        <div class="bg-white p-2 rounded text-xs transition-all duration-300 hover:scale-105 opacity-0">
                            <div>DB Pod</div>
                            <div class="text-[10px] mt-1 text-gray-500 pod-version"></div>
                            <div class="flex gap-1 mt-1">
                                <div class="w-2 h-2 rounded-full bg-green-500"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-2 rounded mb-2 shadow transition-all duration-300">
                    <h4 class="text-sm font-bold">Node 2</h4>
                    <div class="flex gap-2 mt-2">
                        <div class="bg-white p-2 rounded text-xs transition-all duration-300 hover:scale-105 opacity-0">
                            <div>Node.js Pod</div>
                            <div class="text-[10px] mt-1 text-gray-500 pod-version"></div>
                            <div class="flex gap-1 mt-1">
                                <div class="w-2 h-2 rounded-full bg-green-500"></div>
                            </div>
                        </div>
                        <div class="bg-white p-2 rounded text-xs transition-all duration-300 hover:scale-105 opacity-0">
                            <div>DB Pod</div>
                            <div class="text-[10px] mt-1 text-gray-500 pod-version"></div>
                            <div class="flex gap-1 mt-1">
                                <div class="w-2 h-2 rounded-full bg-green-500"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-2 rounded mb-2 shadow transition-all duration-300">
                    <h4 class="text-sm font-bold">Node 3</h4>
                    <div class="flex gap-2 mt-2">
                        <div class="bg-white p-2 rounded text-xs transition-all duration-300 hover:scale-105 opacity-0">
                            <div>Node.js Pod</div>
                            <div class="text-[10px] mt-1 text-gray-500 pod-version"></div>
                            <div class="flex gap-1 mt-1">
                                <div class="w-2 h-2 rounded-full bg-green-500"></div>
                            </div>
                        </div>
                        <div class="bg-white p-2 rounded text-xs transition-all duration-300 hover:scale-105 opacity-0">
                            <div>DB Pod</div>
                            <div class="text-[10px] mt-1 text-gray-500 pod-version"></div>
                            <div class="flex gap-1 mt-1">
                                <div class="w-2 h-2 rounded-full bg-green-500"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="status-indicator absolute w-4 h-4 rounded-full right-3 top-3 bg-gray-300"></div>
        </div>
        
        <!-- Pipelines -->
        <div class="absolute h-2.5 bg-gray-200 z-0" style="width: 100px; left: 300px; top: 125px;"></div>
        <div class="absolute h-2.5 bg-gray-200 z-0" style="width: 100px; left: 800px; top: 125px;"></div>
        
        <!-- Quality Gates -->
        <div id="gate1" class="absolute w-12 h-12 flex justify-center items-center text-white font-bold shadow-md z-10 bg-gray-600 overflow-hidden ci-border" style="left: 325px; top: 100px;">
            <div class="ci-badge">CI</div>
            QG1
        </div>
        
        <div id="gate2" class="absolute w-12 h-12 flex justify-center items-center text-white font-bold shadow-md z-10 bg-gray-600 overflow-hidden cd-border" style="left: 825px; top: 100px;">
            <div class="cd-badge">CD</div>
            QG2
        </div>
        
        <!-- Container Registry -->
        <div class="absolute bg-purple-100 text-purple-800 p-4 rounded-lg border-2 border-purple-300 transition-all duration-300 cd-border" 
             style="width: 275px; left: 525px; top: 400px;">
            <div class="cd-badge">CD</div>
            <h4 class="text-sm font-bold mb-2">Container Registry</h4>
            <div class="space-y-1 text-xs max-h-[150px] overflow-y-auto pr-2" style="scrollbar-width: thin;">
                <div class="bg-white p-2 rounded transition-all duration-200 hover:translate-x-1 hover:bg-gray-50">database:latest</div>
            </div>
        </div>
        
        <!-- Gate Popups -->
        <div id="gate1-popup" class="absolute bg-white border border-gray-200 rounded-lg p-4 shadow-lg z-20 hidden" style="left: 325px; top: 120px;">
            <h4 class="font-bold text-gray-800 mb-2">Quality Gate 1</h4>
            <ul class="list-disc pl-5 text-sm text-gray-600 space-y-1">
                <li>Code review</li>
                <li>Unit tests pass (>80%)</li>
                <li>Static code analysis</li>
                <li>Build succeeds</li>
            </ul>
        </div>
        
        <div id="gate2-popup" class="absolute bg-white border border-gray-200 rounded-lg p-4 shadow-lg z-20 hidden" style="left: 825px; top: 120px;">
            <h4 class="font-bold text-gray-800 mb-2">Quality Gate 2</h4>
            <ul class="list-disc pl-5 text-sm text-gray-600 space-y-1">
                <li>Integration tests pass</li>
                <li>Performance tests</li>
                <li>Security scan</li>
                <li>UAT approval</li>
            </ul>
        </div>
        
        <!-- Controls -->
        <div class="absolute bottom-5 left-1/2 transform -translate-x-1/2 z-10 flex gap-3">
            <button id="startBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors duration-200">
                Start Deployment
            </button>
            <button id="resetBtn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded transition-colors duration-200">
                Reset
            </button>
        </div>
        
        <!-- Legend -->
        <div class="absolute top-8 right-5 bg-white/90 rounded-lg p-4 shadow-md">
            <h4 class="font-bold mb-2">Legend</h4>
            <div class="flex items-center mb-2">
                <div class="w-4 h-4 mr-3 rounded bg-blue-500"></div>
                <span>Code Package</span>
            </div>
            <div class="flex items-center mb-2">
                <div class="w-4 h-4 mr-3 rounded bg-green-400"></div>
                <span>Success</span>
            </div>
            <div class="flex items-center mb-2">
                <div class="w-4 h-4 mr-3 rounded bg-red-500"></div>
                <span>Failure</span>
            </div>
            <div class="flex items-center mb-2">
                <div class="w-4 h-4 mr-3 rounded bg-yellow-400"></div>
                <span>In Progress</span>
            </div>
            <div class="flex items-center mb-2">
                <div class="w-4 h-4 mr-3 rounded bg-gray-400"></div>
                <span>Idle</span>
            </div>
            <div class="flex items-center mb-2">
                <div class="w-4 h-4 mr-3 rounded bg-gray-600"></div>
                <span>Quality Gate</span>
            </div>
        </div>
        
        <!-- Deployment Status Banner -->
        <div id="deployment-status" class="absolute bottom-24 left-1/2 transform -translate-x-1/2 bg-white/90 rounded-lg p-3 shadow-lg z-20 hidden transition-all duration-300 w-[600px] max-w-[90vw]">
            <div class="flex justify-between items-center mb-2">
                <h3 class="font-bold text-gray-800">Deployment in Progress</h3>
                <span id="deployment-version" class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-mono">v1.0.0</span>
            </div>
            <div class="flex justify-between mb-1">
                <div class="flex-1 text-xs text-center">Build</div>
                <div class="flex-1 text-xs text-center">Quality Gate 1</div>
                <div class="flex-1 text-xs text-center">Test</div>
                <div class="flex-1 text-xs text-center">Quality Gate 2</div>
                <div class="flex-1 text-xs text-center">Production</div>
            </div>
            <div class="h-2 w-full bg-gray-200 rounded-full overflow-hidden">
                <div id="progress-bar" class="h-full bg-blue-500 transition-all duration-500" style="width: 0%"></div>
            </div>
            <div id="deployment-message" class="text-xs text-gray-600 mt-2 text-center">Initializing deployment...</div>
        </div>
        
        <!-- Connection Lines -->
        <svg class="absolute z-0" style="width: 100%; height: 100%;">
            <path id="dev-test-path" class="connection-path" d="M 300 125 L 400 125" stroke="#ccc" stroke-width="2" fill="none" opacity="0.5" />
            <path id="test-prod-path" class="connection-path" d="M 800 125 L 900 125" stroke="#ccc" stroke-width="2" fill="none" opacity="0.5" />
        </svg>
    </div>
    
    <script>
        // Main variables
        let deploymentStage = 0;
        let codePackage = null;
        let isRunning = false;
        let failureRate = 0.2; // 20% chance of failure at each gate
        let version = { major: 1, minor: 0, patch: 0 };
        
        // DOM elements
        const startBtn = document.getElementById('startBtn');
        const resetBtn = document.getElementById('resetBtn');
        const devStage = document.getElementById('dev-stage');
        const testStage = document.getElementById('test-stage');
        const prodStage = document.getElementById('prod-stage');
        const gate1 = document.getElementById('gate1');
        const gate2 = document.getElementById('gate2');
        const gate1Popup = document.getElementById('gate1-popup');
        const gate2Popup = document.getElementById('gate2-popup');
        const deploymentStatus = document.getElementById('deployment-status');
        const progressBar = document.getElementById('progress-bar');
        const deploymentMessage = document.getElementById('deployment-message');
        const deploymentVersion = document.getElementById('deployment-version');
        
        // Event listeners
        startBtn.addEventListener('click', startDeployment);
        resetBtn.addEventListener('click', resetDeployment);
        
        // Gate popup listeners
        gate1.addEventListener('mouseenter', () => gate1Popup.classList.remove('hidden'));
        gate1.addEventListener('mouseleave', () => gate1Popup.classList.add('hidden'));
        gate2.addEventListener('mouseenter', () => gate2Popup.classList.remove('hidden'));
        gate2.addEventListener('mouseleave', () => gate2Popup.classList.add('hidden'));
        
        // Initialize the state
        function init() {
            updateStageStatus(devStage, 'idle');
            updateStageStatus(testStage, 'idle');
            updateStageStatus(prodStage, 'idle');
        }
        
        // Start the deployment process
        function startDeployment() {
            if (isRunning) return;
            isRunning = true;
            
            // Reset the deployment without resetting the running state
            resetDeployment(false);
            
            // Create a new version for this deployment
            version.patch++;
            if (version.patch >= 10) {
                version.patch = 0;
                version.minor++;
            }
            if (version.minor >= 10) {
                version.minor = 0;
                version.major++;
            }
            
            // Create the code package
            codePackage = document.createElement('div');
            codePackage.classList.add('bg-blue-500', 'text-white', 'p-2', 'rounded', 'shadow-md', 'absolute', 'transition-all', 'duration-300', 'z-10', 'cursor-pointer', 'text-ellipsis', 'overflow-hidden', 'max-w-[60px]');
            codePackage.innerHTML = 'App';
            codePackage.style.width = '60px';
            codePackage.style.textAlign = 'center';
            codePackage.style.left = (devStage.offsetLeft + devStage.offsetWidth / 2 - 30) + 'px';
            codePackage.style.top = (devStage.offsetTop + devStage.offsetHeight / 2 - 15) + 'px';
            document.querySelector('.relative').appendChild(codePackage);
            
            // Add tooltip to package
            codePackage.title = `Version: ${version.major}.${version.minor}.${version.patch}\nCommit: ${generateCommitHash()}\nBuild time: ${new Date().toLocaleTimeString()}`;
            
            // Show deployment status banner
            deploymentStatus.classList.remove('hidden');
            deploymentMessage.textContent = 'Initializing deployment...';
            deploymentVersion.textContent = `v${version.major}.${version.minor}.${version.patch}`;
            
            // Start the deployment flow
            updateStageStatus(devStage, 'processing');
            simulateDevelopment();
        }

        // Create container image
        function createContainerImage() {
            const image = document.createElement('div');
            image.className = 'absolute w-8 h-8 bg-indigo-400 rounded transition-all duration-500 shadow-md z-10';
            return image;
        }

        // Deploy containers to Kubernetes
        function deployToKubernetes(stage, onComplete) {
            const container = createContainerImage();
            document.querySelector('.relative').appendChild(container);
            
            // Update version label
            const targetStage = stage === 'test' ? 
                document.getElementById('test-stage') : 
                document.getElementById('prod-stage');
            
            const versionLabel = targetStage.querySelector('.version-label');
            versionLabel.textContent = 'Deploying ' + version.major + '.' + version.minor + '.' + version.patch + '...';

            // Move to registry first
            const registry = document.querySelector('.bg-purple-100');
            container.style.left = (registry.offsetLeft + registry.offsetWidth / 2 - 15) + 'px';
            container.style.top = (registry.offsetTop + 20) + 'px';

            setTimeout(() => {
                // Find target node in the stage
                const targetStage = stage === 'test' ? testStage : prodStage;
                const node = targetStage.querySelector('.bg-yellow-50, .bg-green-50');
                const nodes = node.querySelectorAll('.bg-white');
                let podIndex = 0;

                // Deploy to all nodes
                nodes.forEach((nodeElement) => {
                    const pods = nodeElement.querySelectorAll('.p-2.rounded.text-xs');
                    pods.forEach((pod, index) => {
                        const newContainer = createContainerImage();
                        document.querySelector('.relative').appendChild(newContainer);
                        newContainer.style.left = container.style.left;
                        newContainer.style.top = container.style.top;

                        setTimeout(() => {
                            const rect = pod.getBoundingClientRect();
                            newContainer.style.left = (rect.left + window.scrollX) + 'px';
                            newContainer.style.top = (rect.top + window.scrollY) + 'px';
                            newContainer.style.transform = 'scale(0.5)';

                            const delay = Math.random() * 1000 + 500; // Random delay between 500-1500ms
                            setTimeout(() => {
                                // Only proceed with pod update if it's not already the current version
                                if (pod.querySelector('.pod-version')?.textContent !== `${version.major}.${version.minor}.${version.patch}`) {
                                    const rect = pod.getBoundingClientRect();
                                    const newPod = document.createElement('div');
                                    newPod.className = `p-2 rounded text-xs transition-all duration-300 hover:scale-105 ${index === 0 ? 'bg-blue-200' : 'bg-orange-200'}`;
                                    
                                    // Copy pod content with new version
                                    const podContent = document.createElement('div');
                                    podContent.textContent = pod.querySelector('div:first-child').textContent;
                                    const versionLabel = document.createElement('div');
                                    versionLabel.className = 'text-[10px] mt-1 text-gray-500 pod-version';
                                    versionLabel.textContent = `${version.major}.${version.minor}.${version.patch}`;
                                    newPod.appendChild(podContent);
                                    newPod.appendChild(versionLabel);
                                    newPod.style.position = 'absolute';
                                    newPod.style.left = (rect.left + window.scrollX + 20) + 'px';
                                    newPod.style.top = (rect.top + window.scrollY) + 'px';
                                    newPod.style.opacity = '0';
                                    document.querySelector('.relative').appendChild(newPod);
                                    
                                    // Fade in new pod
                                    setTimeout(() => {
                                        newPod.style.opacity = '1';
                                        newPod.style.left = (rect.left + window.scrollX) + 'px';
                                        
                                        // If pod is already visible, animate replacement
                                        if (!pod.classList.contains('opacity-0')) {
                                            const oldPod = pod.cloneNode(true);
                                            oldPod.style.position = 'absolute';
                                            oldPod.style.left = (rect.left + window.scrollX) + 'px';
                                            oldPod.style.top = (rect.top + window.scrollY) + 'px';
                                            document.querySelector('.relative').appendChild(oldPod);
                                            
                                            setTimeout(() => {
                                                oldPod.style.left = (rect.left + window.scrollX - 20) + 'px';
                                                oldPod.style.opacity = '0';
                                                setTimeout(() => {
                                                    if (oldPod.parentNode) {
                                                        oldPod.parentNode.removeChild(oldPod);
                                                    }
                                                }, 300);
                                            }, 100);
                                        }
                                        
                                        // Update the pod in place
                                        pod.classList.remove('opacity-0', 'bg-white');
                                        pod.classList.add(index === 0 ? 'bg-blue-200' : 'bg-orange-200');
                                        pod.querySelector('.pod-version').textContent = `${version.major}.${version.minor}.${version.patch}`;
                                        
                                        // Set pod health to excellent
                                        updatePodHealth(pod, 'excellent');

                                        // Clean up the temporary new pod
                                        setTimeout(() => {
                                            newPod.remove();
                                        }, 500);
                                    }, 100);
                                }
                            }, delay);
                            
                            setTimeout(() => {
                                pod.classList.remove('scale-110');
                                newContainer.remove();
                            }, Math.max(delay + 1000, 300));
                        }, podIndex * 200);
                        podIndex++;
                    });
                });
                
                // Add image to container registry
                const registry = document.querySelector('.bg-purple-100 .space-y-1');
                const newImage = document.createElement('div');
                newImage.className = 'bg-white p-2 rounded transition-all duration-200 hover:translate-x-1 hover:bg-gray-50';
                newImage.textContent = `nodejs-app:${version.major}.${version.minor}.${version.patch}`;
                
                // Check if this version already exists in the registry
                let versionExists = false;
                Array.from(registry.children).forEach(child => {
                    if (child.textContent === newImage.textContent) {
                        versionExists = true;
                    }
                });
                
                // Only add if this version doesn't already exist
                if (!versionExists) {
                    registry.insertBefore(newImage, registry.firstChild);
                    
                    // Keep only the last 4 images
                    while (registry.children.length > 4) {
                        registry.removeChild(registry.lastChild);
                    }
                }
                
                // Update version label after deployment
                setTimeout(() => {
                    const versionLabel = targetStage.querySelector('.version-label');
                    versionLabel.textContent = 'Running ' + version.major + '.' + version.minor + '.' + version.patch;
                }, podIndex * 200);

                // Remove original container
                setTimeout(() => {
                    container.remove();
                    if (onComplete) onComplete();
                }, podIndex * 200 + 1000);
            }, 1000);
        }
        
        // Reset the deployment
        function resetDeployment(resetRunningState) {
            resetRunningState = resetRunningState === undefined ? true : resetRunningState;
            if (codePackage && codePackage.parentNode) {
                codePackage.parentNode.removeChild(codePackage);
            }
            
            codePackage = null;
            
            // Only reset if no deployment is active
            if (!version.major) {
                document.querySelectorAll('.version-label').forEach(label => {
                    label.textContent = 'No version deployed';
                });
                
                document.querySelectorAll('.p-2.rounded.text-xs').forEach(pod => {
                    pod.classList.remove('bg-blue-200', 'bg-orange-200', 'scale-110');
                    pod.classList.add('bg-white', 'opacity-0');
                });
            }
            if (resetRunningState) {
                isRunning = false;
            }
            
            updateStageStatus(devStage, 'idle');
            updateStageStatus(testStage, 'idle');
            updateStageStatus(prodStage, 'idle');
            
            // Hide deployment status banner
            deploymentStatus.classList.add('hidden');
        }
        
        // Update the visual status of a stage
        function updateStageStatus(element, status) {
            const indicator = element.querySelector('.status-indicator');
            
            // Remove all possible status classes
            indicator.classList.remove('bg-gray-300', 'bg-yellow-400', 'bg-green-400', 'bg-red-500', 'animate-pulse');
            element.classList.remove('border-2', 'border-yellow-400', 'border-green-400', 'border-red-500', 'shadow-lg');
            
            switch(status) {
                case 'idle':
                    indicator.classList.add('bg-gray-300');
                    break;
                case 'processing':
                    indicator.classList.add('bg-yellow-400', 'animate-pulse');
                    element.classList.add('border-2', 'border-yellow-400', 'shadow-lg');
                    break;
                case 'success':
                    indicator.classList.add('bg-green-400');
                    element.classList.add('border-2', 'border-green-400', 'shadow-lg');
                    break;
                case 'failure':
                    indicator.classList.add('bg-red-500');
                    element.classList.add('border-2', 'border-red-500', 'shadow-lg');
                    break;
            }
        }
        
        // Move code package to a target
        function movePackageTo(target, onComplete) {
            const targetX = target.offsetLeft + target.offsetWidth / 2 - 15;
            const targetY = target.offsetTop + target.offsetHeight / 2 - 15;
            
            codePackage.style.left = targetX + 'px';
            codePackage.style.top = targetY + 'px';
            
            // Wait for transition to complete
            setTimeout(onComplete, 600);
        }
        
        // Development stage simulation
        function simulateDevelopment() {
            setTimeout(() => {
                updateStageStatus(devStage, 'success');
                deploymentStage = 1;
                
                // Move to first gate
                movePackageTo(gate1, checkGate1);
                
                // Update deployment status banner
                deploymentMessage.textContent = 'Development complete';
                progressBar.style.width = '20%';
            }, 2000);
        }
        
        // Show a step label for a short duration
        function showStepLabel(gate, text, top) {
            const existingLabel = gate.querySelector('[data-step-label]');
            if (existingLabel) {
                existingLabel.remove();
            }

            const label = document.createElement('div');
            label.className = 'absolute left-1/2 transform -translate-x-1/2 bg-white px-3 py-2 rounded text-sm shadow-md z-10 border border-gray-200 text-gray-700 whitespace-nowrap opacity-0 transition-all duration-300';
            label.setAttribute('data-step-label', '');
            label.textContent = text;
            
            // Calculate position below the gate
            label.style.top = (gate.offsetTop + gate.offsetHeight + 20 + top) + 'px';
            document.querySelector('.relative').appendChild(label);
            label.style.left = (gate.offsetLeft + gate.offsetWidth/2) + 'px';
            
            // Add success/failure styling
            if (text.includes('passed')) {
                label.classList.add('bg-green-50', 'border-green-300', 'text-green-800');
            } else if (text.includes('failed')) {
                label.classList.add('bg-red-50', 'border-red-300', 'text-red-800');
            }

            setTimeout(() => {
                label.classList.remove('opacity-0');
                label.classList.add('opacity-100');
                setTimeout(() => {
                    label.classList.remove('opacity-100');
                    label.classList.add('opacity-0');
                    setTimeout(() => {
                        if (label.parentNode) {
                            label.parentNode.removeChild(label);
                        }
                    }, 300);
                }, 1500);
            }, 100);
        }

        // Check first quality gate
        function checkGate1() {
            gate1.classList.add('scanning');
            gate1.classList.add('bg-yellow-500');
            
            // Show step labels for each check
            const steps = [
                { text: 'Running unit tests... (CI)', delay: 0 },
                { text: 'Checking code coverage... (CI)', delay: 500 },
                { text: 'Analyzing code quality... (CI)', delay: 1000 },
                { text: 'Validating dependencies... (CI)', delay: 1500 }
            ];

            steps.forEach((step, index) => {
                setTimeout(() => {
                    showStepLabel(gate1, step.text, index * 40); // Increased spacing between step labels
                }, step.delay);
            });
            
            setTimeout(() => {
                const passed = Math.random() > failureRate;
                
                if (passed) {
                    gate1.classList.remove('bg-yellow-500');
                    gate1.classList.add('bg-green-500');
                    gate1.classList.remove('scanning');
                    showStepLabel(gate1, 'All checks passed!', 10);
                    
                    setTimeout(() => {
                        // Create artifact container
                        const artifact = createContainerImage();
                        document.querySelector('.relative').appendChild(artifact);
                        
                        // Position at gate1
                        const gate1Rect = gate1.getBoundingClientRect();
                        artifact.style.left = (gate1Rect.left + window.scrollX) + 'px';
                        artifact.style.top = (gate1Rect.top + window.scrollY) + 'px';
                        
                        // Move to registry
                        const registry = document.querySelector('.bg-purple-100');
                        setTimeout(() => {
                            artifact.style.left = (registry.offsetLeft + registry.offsetWidth/2 - 15) + 'px';
                            artifact.style.top = (registry.offsetTop + 20) + 'px';
                            
                            // Add new item to registry
                            setTimeout(() => {
                                const newVersion = document.createElement('div');
                                newVersion.className = 'bg-white p-2 rounded transition-all duration-200 hover:translate-x-1 hover:bg-gray-50';
                                newVersion.textContent = `nodejs-app:${version.major}.${version.minor}.${version.patch}`;
                                
                                // Check if this version already exists in the registry
                                const registryList = registry.querySelector('.space-y-1');
                                let versionExists = false;
                                Array.from(registryList.children).forEach(child => {
                                    if (child.textContent === newVersion.textContent) {
                                        versionExists = true;
                                    }
                                });
                                
                                // Only add if this version doesn't already exist
                                if (!versionExists) {
                                    registryList.insertBefore(newVersion, registryList.firstChild);
                                    
                                    // Keep only the last 4 images
                                    while (registryList.children.length > 4) {
                                        registryList.removeChild(registryList.lastChild);
                                    }
                                }
                                
                                // Scale down and remove artifact
                                artifact.style.transform = 'scale(0.5)';
                                setTimeout(() => {
                                    artifact.remove();
                                    // Move to test stage
                                    movePackageTo(testStage, enterTestStage);
                                    
                                    // Update deployment status banner
                                    deploymentMessage.textContent = 'Quality Gate 1 passed';
                                    progressBar.style.width = '40%';
                                }, 500);
                            }, 500);
                        }, 500);
                    }, 1000);
                } else {
                    gate1.classList.remove('bg-yellow-500');
                    gate1.classList.add('bg-red-500');
                    gate1.classList.remove('scanning');
                    showStepLabel(gate1, 'Check failed!', 10);
                    
                    // Simulate failure
                    setTimeout(() => {
                        if (codePackage) {
                            codePackage.style.opacity = '0';
                            setTimeout(() => {
                                if (codePackage && codePackage.parentNode) {
                                    codePackage.parentNode.removeChild(codePackage);
                                }
                                codePackage = null;
                                isRunning = false;
                                gate1.classList.remove('bg-red-500');
                                gate1.classList.add('bg-gray-500');
                            }, 500);
                        }
                    }, 1000);
                }
            }, 2000);
        }
        
        // Enter test stage
        function enterTestStage() {
            updateStageStatus(testStage, 'processing');
            gate1.classList.remove('bg-green-500');
            gate1.classList.add('bg-gray-500');
            
            // Deploy to test environment
            deployToKubernetes('test', () => {
                setTimeout(() => {
                    updateStageStatus(testStage, 'success');
                    deploymentStage = 2;
                    
                    // Move to second gate
                    movePackageTo(gate2, checkGate2);
                    
                    // Update deployment status banner
                    deploymentMessage.textContent = 'Test environment deployed';
                    progressBar.style.width = '60%';
                }, 2000);
            });
        }
        
        // Check second quality gate
        function checkGate2() {
            gate2.classList.add('scanning');
            gate2.classList.add('bg-yellow-500');
            
            // Show step labels for each check
            const steps = [
                { text: 'Checking integration tests... (CD)', delay: 0 },
                { text: 'Validating API endpoints... (CD)', delay: 500 },
                { text: 'Testing database migrations... (CD)', delay: 1000 },
                { text: 'Verifying performance... (CD)', delay: 1500 }
            ];

            steps.forEach((step, index) => {
                setTimeout(() => {
                    showStepLabel(gate2, step.text, index * 40); // Increased spacing between step labels
                }, step.delay);
            });
            
            setTimeout(() => {
                const passed = Math.random() > failureRate;
                
                if (passed) {
                    gate2.classList.remove('bg-yellow-500');
                    gate2.classList.add('bg-green-500');
                    gate2.classList.remove('scanning');
                    showStepLabel(gate2, 'All checks passed!', 10);
                    
                    setTimeout(() => {
                        // Move to production stage
                        movePackageTo(prodStage, enterProdStage);
                        
                        // Update deployment status banner
                        deploymentMessage.textContent = 'Quality Gate 2 passed';
                        progressBar.style.width = '80%';
                    }, 1000);
                } else {
                    gate2.classList.remove('bg-yellow-500');
                    gate2.classList.add('bg-red-500');
                    gate2.classList.remove('scanning');
                    showStepLabel(gate2, 'Check failed!', 10);
                    
                    // Simulate failure
                    setTimeout(() => {
                        if (codePackage) {
                            codePackage.style.opacity = '0';
                            setTimeout(() => {
                                if (codePackage && codePackage.parentNode) {
                                    codePackage.parentNode.removeChild(codePackage);
                                }
                                codePackage = null;
                                isRunning = false;
                                gate2.classList.remove('bg-red-500');
                                gate2.classList.add('bg-gray-500');
                            }, 500);
                        }
                    }, 1000);
                }
            }, 2000);
        }
        
        // Enter production stage
        function enterProdStage() {
            updateStageStatus(prodStage, 'processing');
            gate2.classList.remove('bg-green-500');
            gate2.classList.add('bg-gray-500');
            
            // Deploy to production environment
            deployToKubernetes('prod', () => {
                setTimeout(() => {
                    updateStageStatus(prodStage, 'success');
                    deploymentStage = 3;
                    
                    // Enable restarting
                    isRunning = false;
                    
                    // Update deployment status banner
                    deploymentMessage.textContent = 'Deployment complete';
                    progressBar.style.width = '100%';
                    setTimeout(() => {
                        deploymentStatus.classList.add('hidden');
                    }, 2000);
                }, 2000);
            });
        }
        
        // Generate a random commit hash
        function generateCommitHash() {
            const characters = '0123456789abcdef';
            let result = '';
            for (let i = 0; i < 7; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }
        
        // Update pod health indicators
        function updatePodHealth(pod, health) {
            // health can be 'excellent', 'good', 'warning', 'error'
            const indicators = pod.querySelectorAll('.w-2.h-2.rounded-full');
            
            indicators.forEach(i => i.className = 'w-2 h-2 rounded-full bg-green-500');
        }
        
        // Initialize on page load
        window.onload = init;
    </script>
</body>
</html>
